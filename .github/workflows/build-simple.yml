name: Build RBeaver (Windows & Linux)

# æ‰‹åŠ¨è§¦å‘ï¼Œä¸è‡ªåŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'å‘å¸ƒæ ‡ç­¾ (å¯é€‰)'
        required: false
        default: ''
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: æž„å»º ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux æž„å»º
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            artifact_name: rbeaver
            asset_name: rbeaver-linux-x86_64
          # Windows æž„å»º
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            artifact_name: rbeaver.exe
            asset_name: rbeaver-windows-x86_64.exe

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust å·¥å…·é“¾
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: å®‰è£… Linux ä¾èµ–
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libfontconfig1-dev \
          libfreetype6-dev \
          libxcb-composite0-dev \
          libxcb-damage0-dev \
          libxcb-dpms0-dev \
          libxcb-dri2-0-dev \
          libxcb-dri3-dev \
          libxcb-glx0-dev \
          libxcb-present-dev \
          libxcb-randr0-dev \
          libxcb-record0-dev \
          libxcb-render0-dev \
          libxcb-res0-dev \
          libxcb-screensaver0-dev \
          libxcb-shape0-dev \
          libxcb-shm0-dev \
          libxcb-sync-dev \
          libxcb-xf86dri0-dev \
          libxcb-xfixes0-dev \
          libxcb-xinput-dev \
          libxcb-xkb-dev \
          libxcb-xtest0-dev \
          libxcb-xv0-dev \
          libxcb-xvmc0-dev \
          libxcb1-dev \
          libxkbcommon-x11-dev \
          libxkbcommon-dev \
          libwayland-dev \
          libssl-dev \
          libpq-dev

    - name: ç¼“å­˜ Cargo ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ matrix.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ matrix.os }}-${{ matrix.target }}-cargo-
          ${{ matrix.os }}-cargo-

    - name: æ‰§è¡Œ Release æž„å»º
      if: github.event.inputs.build_type == 'release'
      run: cargo build --release --target ${{ matrix.target }} --verbose

    - name: æ‰§è¡Œ Debug æž„å»º
      if: github.event.inputs.build_type == 'debug'
      run: cargo build --target ${{ matrix.target }} --verbose

    - name: è¿è¡Œæµ‹è¯•
      run: cargo test --target ${{ matrix.target }} --verbose

    - name: å‡†å¤‡æž„å»ºäº§ç‰©ç›®å½•
      run: mkdir -p artifacts

    - name: å‡†å¤‡ Release æž„å»ºäº§ç‰©
      if: github.event.inputs.build_type == 'release'
      shell: bash
      run: |
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} artifacts/${{ matrix.asset_name }}
        else
          cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} artifacts/${{ matrix.asset_name }}
          chmod +x artifacts/${{ matrix.asset_name }}
        fi

    - name: å‡†å¤‡ Debug æž„å»ºäº§ç‰©
      if: github.event.inputs.build_type == 'debug'
      shell: bash
      run: |
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          cp target/${{ matrix.target }}/debug/${{ matrix.artifact_name }} artifacts/${{ matrix.asset_name }}-debug
        else
          cp target/${{ matrix.target }}/debug/${{ matrix.artifact_name }} artifacts/${{ matrix.asset_name }}-debug
          chmod +x artifacts/${{ matrix.asset_name }}-debug
        fi

    - name: åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
      shell: bash
      run: |
        echo "RBeaver - PostgreSQL æ•°æ®åº“ç®¡ç†å·¥å…·" > artifacts/README-${{ matrix.platform }}.txt
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.release_tag || 'å¼€å‘ç‰ˆæœ¬' }}" >> artifacts/README-${{ matrix.platform }}.txt
        echo "æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type }}" >> artifacts/README-${{ matrix.platform }}.txt
        echo "ç›®æ ‡å¹³å°: ${{ matrix.target }}" >> artifacts/README-${{ matrix.platform }}.txt
        echo "æž„å»ºæ—¶é—´: $(date)" >> artifacts/README-${{ matrix.platform }}.txt
        echo "" >> artifacts/README-${{ matrix.platform }}.txt
        echo "å®‰è£…è¯´æ˜Ž:" >> artifacts/README-${{ matrix.platform }}.txt
        if [[ "${{ matrix.platform }}" == "linux" ]]; then
          echo "1. ä¸‹è½½ ${{ matrix.asset_name }}" >> artifacts/README-${{ matrix.platform }}.txt
          echo "2. è®¾ç½®æ‰§è¡Œæƒé™: chmod +x ${{ matrix.asset_name }}" >> artifacts/README-${{ matrix.platform }}.txt
          echo "3. è¿è¡Œ: ./${{ matrix.asset_name }}" >> artifacts/README-${{ matrix.platform }}.txt
        else
          echo "1. ä¸‹è½½ ${{ matrix.asset_name }}" >> artifacts/README-${{ matrix.platform }}.txt
          echo "2. åŒå‡»è¿è¡Œç¨‹åº" >> artifacts/README-${{ matrix.platform }}.txt
        fi

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: rbeaver-${{ matrix.platform }}-${{ github.event.inputs.build_type }}
        path: artifacts/
        retention-days: 7

  # å¦‚æžœæä¾›äº†å‘å¸ƒæ ‡ç­¾ä¸”æ˜¯ release æž„å»ºï¼Œåˆ™åˆ›å»º GitHub Release
  release:
    name: åˆ›å»º GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.release_tag != '' && github.event.inputs.build_type == 'release'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        path: ./release-artifacts

    - name: æ˜¾ç¤ºä¸‹è½½çš„æ–‡ä»¶ç»“æž„
      run: |
        echo "æž„å»ºäº§ç‰©ç»“æž„:"
        find ./release-artifacts -type f -ls

    - name: å‡†å¤‡å‘å¸ƒèµ„æº
      run: |
        mkdir -p release-assets

        # å¤åˆ¶ Linux æž„å»ºäº§ç‰©
        if [ -f "./release-artifacts/rbeaver-linux-release/rbeaver-linux-x86_64" ]; then
          cp "./release-artifacts/rbeaver-linux-release/rbeaver-linux-x86_64" release-assets/
          cp "./release-artifacts/rbeaver-linux-release/README-linux.txt" release-assets/
        fi

        # å¤åˆ¶ Windows æž„å»ºäº§ç‰©
        if [ -f "./release-artifacts/rbeaver-windows-release/rbeaver-windows-x86_64.exe" ]; then
          cp "./release-artifacts/rbeaver-windows-release/rbeaver-windows-x86_64.exe" release-assets/
          cp "./release-artifacts/rbeaver-windows-release/README-windows.txt" release-assets/
        fi

        ls -la release-assets/

    - name: ç”Ÿæˆæ ¡éªŒå’Œ
      run: |
        cd release-assets
        sha256sum rbeaver-* > checksums.sha256
        echo "SHA256 æ ¡éªŒå’Œ:"
        cat checksums.sha256

    - name: åˆ›å»º GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.release_tag }}
        release_name: RBeaver ${{ github.event.inputs.release_tag }}
        body: |
          # RBeaver ${{ github.event.inputs.release_tag }} å‘å¸ƒ

          RBeaver æ˜¯ä¸€ä¸ªçŽ°ä»£åŒ–çš„ PostgreSQL æ•°æ®åº“ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨ Rust å’Œ GPUI æž„å»ºã€‚

          ## ä¸‹è½½

          ### Windows (x86_64)
          - æ–‡ä»¶: `rbeaver-windows-x86_64.exe`
          - ç³»ç»Ÿè¦æ±‚: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - å®‰è£…: ç›´æŽ¥ä¸‹è½½å¹¶åŒå‡»è¿è¡Œ

          ### Linux (x86_64)
          - æ–‡ä»¶: `rbeaver-linux-x86_64`
          - ç³»ç»Ÿè¦æ±‚: æ”¯æŒ X11 æˆ– Wayland çš„çŽ°ä»£ Linux å‘è¡Œç‰ˆ
          - å®‰è£…:
            ```bash
            chmod +x rbeaver-linux-x86_64
            ./rbeaver-linux-x86_64
            ```

          ## åŠŸèƒ½ç‰¹æ€§

          - ðŸ”— PostgreSQL è¿žæŽ¥ç®¡ç†
          - ðŸ—„ï¸ æ•°æ®åº“æž¶æž„æµè§ˆ
          - ðŸ“ SQL æŸ¥è¯¢ç¼–è¾‘å™¨ï¼ˆè®¡åˆ’ä¸­ï¼‰
          - ðŸ”„ è¿žæŽ¥æ± æ”¯æŒ
          - ðŸ›¡ï¸ SSL/TLS å®‰å…¨è¿žæŽ¥
          - ðŸŽ¨ çŽ°ä»£åŒ–ç”¨æˆ·ç•Œé¢

          ## æ•°æ®åº“æ”¯æŒ

          - âœ… PostgreSQL (æ‰€æœ‰ç‰ˆæœ¬)
          - ðŸ”„ ä½¿ç”¨ deadpool-postgres è¿›è¡Œè¿žæŽ¥æ± ç®¡ç†
          - âš¡ SQLx é›†æˆæ”¯æŒé«˜çº§æŸ¥è¯¢
          - ðŸ” æ”¯æŒå¤šç§ SSL æ¨¡å¼

          ## ç³»ç»Ÿè¦æ±‚

          ### Linux
          - çŽ°ä»£ Linux å‘è¡Œç‰ˆ (Ubuntu 18.04+, CentOS 8+, ç­‰)
          - X11 æˆ– Wayland æ¡Œé¢çŽ¯å¢ƒ
          - ç³»ç»Ÿåº“: fontconfig, freetype, xcb, wayland

          ### Windows
          - Windows 10 æˆ– Windows 11
          - Visual C++ å¯å†å‘è¡Œç»„ä»¶åŒ… (é€šå¸¸å·²é¢„å®‰è£…)

          ## éªŒè¯ä¸‹è½½

          æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½æä¾› SHA256 æ ¡éªŒå’Œï¼Œè¯·éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š

          ```bash
          # Linux/macOS
          sha256sum -c checksums.sha256

          # Windows (PowerShell)
          Get-FileHash rbeaver-windows-x86_64.exe -Algorithm SHA256
          ```

          ## å¿«é€Ÿå¼€å§‹

          1. ä¸‹è½½é€‚åˆæ‚¨å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. è¿è¡Œåº”ç”¨ç¨‹åº
          3. ç‚¹å‡» "æ–°å»ºè¿žæŽ¥" è®¾ç½® PostgreSQL æ•°æ®åº“è¿žæŽ¥
          4. è¾“å…¥è¿žæŽ¥è¯¦æƒ…å¹¶æµ‹è¯•è¿žæŽ¥
          5. å¼€å§‹æŽ¢ç´¢æ‚¨çš„æ•°æ®åº“ç»“æž„

          ## é—®é¢˜åé¦ˆ

          å¦‚æœ‰é—®é¢˜æˆ–åŠŸèƒ½å»ºè®®ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æäº¤ã€‚

          ---
          **æž„å»ºä¿¡æ¯:**
          - æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - æž„å»ºç±»åž‹: Release
          - æ”¯æŒå¹³å°: Windows x86_64, Linux x86_64

        draft: false
        prerelease: false

    - name: ä¸Šä¼  Linux å‘å¸ƒèµ„æº
      if: hashFiles('release-assets/rbeaver-linux-x86_64') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-assets/rbeaver-linux-x86_64
        asset_name: rbeaver-linux-x86_64
        asset_content_type: application/octet-stream

    - name: ä¸Šä¼  Windows å‘å¸ƒèµ„æº
      if: hashFiles('release-assets/rbeaver-windows-x86_64.exe') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-assets/rbeaver-windows-x86_64.exe
        asset_name: rbeaver-windows-x86_64.exe
        asset_content_type: application/octet-stream

    - name: ä¸Šä¼ æ ¡éªŒå’Œæ–‡ä»¶
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-assets/checksums.sha256
        asset_name: checksums.sha256
        asset_content_type: text/plain

    - name: ä¸Šä¼  README æ–‡ä»¶
      if: hashFiles('release-assets/README-*.txt') != ''
      run: |
        for readme in release-assets/README-*.txt; do
          if [ -f "$readme" ]; then
            filename=$(basename "$readme")
            gh release upload ${{ github.event.inputs.release_tag }} "$readme" --clobber
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: æž„å»ºæ€»ç»“
    needs: [build]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: ç”Ÿæˆæž„å»ºæ€»ç»“
      run: |
        echo "## ðŸŽ¯ RBeaver æž„å»ºæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æž„å»ºé…ç½®" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: æ‰‹åŠ¨è§¦å‘" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºç±»åž‹**: ${{ github.event.inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å‘å¸ƒæ ‡ç­¾**: ${{ github.event.inputs.release_tag || 'æ— ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºå¹³å°**: Windows x86_64, Linux x86_64" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æž„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.build.result }}" == "success" ]]; then
          echo "- **æž„å»ºç»“æžœ**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **æž„å»ºç»“æžœ**: âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ä¸‹è½½æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "æž„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Actions artifactsï¼Œå¯åœ¨ Actions é¡µé¢ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ github.event.inputs.release_tag }}" != "" && "${{ github.event.inputs.build_type }}" == "release" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ å·²åˆ›å»º GitHub Release: [${{ github.event.inputs.release_tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.release_tag }})" >> $GITHUB_STEP_SUMMARY
        fi
